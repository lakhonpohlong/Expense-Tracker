<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Credit Card Details</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    nav {
      position: sticky;
      top: 0;
      /* Sticks to the top of the viewport */
      z-index: 1000;
      /* Ensures it stays above other content */
      background-color: rgb(237, 242, 237);
      /* Optional: adds background */
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
      /* Optional: adds subtle shadow */
      padding: 0.7rem;
      text-align: center;
    }



    .navbar-custom a {
      color: rgb(40, 28, 28);
      text-decoration: none;
      margin: 0 0.2rem;
    }

    .navbar-custom a:hover {
      text-decoration: underline;
    }

    .navbar-custom a.active {
      color: #2a2626;
      font-weight: bold;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .container2 {
      margin-top: -20px;
    }

    /* Custom styles for compact design with background */
    .card-details {
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 0px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-weight: bold;
      margin-bottom: 4px;
      color: #363636;
      text-align: center;
    }

    .titleHead {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .data-item {
      font-size: 0.83rem;
      margin-bottom: 1px;
      color: #4a4a4a;
    }

    .data-item-title {
      color: #8a8a8a;
      font-weight: bold;
    }

    .data-item-value {
      color: #363636;
      font-weight: 400;
    }

    .one-line {
      white-space: nowrap;
      /* Prevent text from wrapping to the next line */
      overflow: hidden;
      /* Hide the overflowed text */
      text-overflow: ellipsis;
      /* Add "..." for the truncated content */
      width: 200px;
      /* Set a fixed width to constrain the content */
    }

    .hlp {
      padding: 2px;
    }

    .box {
      padding: 10px;
      max-width: 500px;
    }

    .media-content {
      overflow: hidden;
    }

    .cash-button {
      width: 16rem
    }

    .modal-content {
      margin: 10px;
      background: pink
    }

    /* Selected buttons container (as before) */
    .selected-buttons {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .selected-button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }



    .fade {
      transition: opacity 0.3s ease;
      opacity: 0;
    }

    .visible {
      display: flex;
      opacity: 1;
    }

    .title-header {
      font-size: 1.5rem;
      color: #333;
      text-align: center;
      margin: 20px 0;
    }

    /* Third set: Input fields layout */
    .input-set {
      margin: 20px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .input-field {
      margin-bottom: 15px;
      width: 70%;
    }

    .modal-card {
      width: 90%;
      max-width: 400px;
    }

    .notify-msg {
      height: auto;
      font-size: 1rem;
      /* visibility: hidden; */
    }

    .notify-msg.success {
      color: #33691e;
      visibility: visible;
    }

    .notify-msg.error {
      color: #cd5244;
      visibility: visible;
    }

    /* dynamic buttons */
    .custom-button {
      margin-bottom: 10px;
      color: #3273dc;
      border-radius: 5px;
      box-shadow: 0 4px 6px rgba(50, 115, 220, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      width: 50%;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .custom-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 8px rgba(50, 115, 220, 0.3);
    }

    .selected-label {
      font-size: 1.5em;
      font-weight: bold;
      color: #3273dc;
      background-color: #e6f7ff;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 4px 6px rgba(50, 115, 220, 0.2);
      margin-bottom: 20px;
    }

    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .form-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Light Navbar -->
  <nav class="navbar-custom">
    <div class="container">
      <a class="nav-item active" href="#" id="homeNav" onclick="showSection('home','homeNav')">Home</a>
      <a class="nav-item" href="#" id="profileNav" onclick="showSection('profile','profileNav')">Profile</a>
      <a class="nav-item" href="#" id="credit-cardNav" onclick="showSection('credit-card','credit-cardNav')">Card</a>
      <a class="nav-item" id="transactionNav" onclick="showSection('transaction','transactionNav')">Transaction</a>
      <a class="nav-item" id="settingNav" href="#" onclick="showSection('setting','settingNav')">Setting</a>
    </div>
  </nav>
  <main class="container2">
    <section id="home" class="section active">
      <div class="titleHead">Credit Card Details</div>
      <div class="columns is-mobile is-multiline" id="dashboard-content">
      </div>
    </section> <!-- start profile section -->
    <section id="profile" class="section">
      <div class="is-flex is-flex-row is-justify-content-space-between">
        <div class="titleHead">Profile List</div>
        <button class="button modal-button" id="addBtn" data-modal="profile-modal"><i class="fas fa-plus"></i>
          <span class="pl-1">Add Profile</span>
        </button>
      </div>
      <table class="table is-striped is-hoverable is-fullwidth">
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Salary</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="profile-table">
        </tbody>
      </table>
    </section>

    <section id="credit-card" class="section">
      <div class="is-flex is-flex-row is-justify-content-space-between">
        <div class="titleHead">Credit Card List</div>
        <button class="button modal-button" id="addBtn" data-modal="credit-card-modal"><i class="fas fa-plus"></i>
          <span class="pl-1">Add New</span>
        </button>
      </div>
      <table class="table is-striped is-hoverable">
        <thead>
          <tr>
            <th class="is-size-7-mobile">Card</th>
            <th class="is-size-7-mobile">Limit</th>
            <th class="is-size-7-mobile">Utilized</th>
            <th class="is-size-7-mobile">Rem.</th>
            <th class="is-size-7-mobile">Actions</th>
          </tr>
        </thead>
        <tbody id="credit-card-table">
        </tbody>
      </table>
    </section>
    <!-- transaction section -->
    <section id="transaction" class="section">

      <div class="is-flex is-flex-row is-justify-content-space-between">
        <div class="titleHead">Transaction List</div>
        <button class="button" id="addBtn" onclick="showSection('addTransaction','transactionNav')"><i
            class="fas fa-plus"></i>
          <span class="pl-1">Add New</span>
        </button>
      </div>
      <div class="box" id="transaction-list">
        <!-- Transactions will be dynamically inserted here -->
      </div>
      <div class="pagination-controls" id="pagination-controls">
        <!-- Pagination buttons will be dynamically inserted here -->
      </div>
    </section>
    <section id="addTransaction" class="section">
      <div class="container">
        <h1 class="title is-size-4 has-text-centered">Personal Expense Management Form</h1>
        <div class="selected-label" id="selected-label">Selected: None</div>
        <div id="button-set-1" class="button-container"></div>
        <div id="button-set-2" class="button-container hidden"></div>
        <div id="form-container" class="form-container hidden">
          <form>
            <input type="text" id="input-item" class="input is-primary" placeholder="Enter Item Name"
              style="margin-bottom: 10px; width: 50%;" required>
            <input type="number" id="input-amount" class="input is-primary" placeholder="Enter Amount"
              style="margin-bottom: 10px; width: 50%;" required>
            <button id="submit-button" class="button custom-button" style="background-color: #f0fff4;"> <i
                class="fas fa-check"></i><span class="pl-1">Submit</button>
          </form>
        </div>
        <button id="back-button" class="button custom-button hidden" style="background-color: #fff8e6;"> <i
            class="fas fa-arrow-left"></i><span class="pl-1">Back</span></button>
      </div>
    </section>
    <section id="setting" class="section">
      <h2 class="title">Setting</h2>
      <p>Manage your setting information here.</p>
    </section>
  </main> <!-- Modals -->

  <!-- Modal -->
  <div class="modal" id="profile-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title is-size-5">Profile Form</p>
        <button class="delete" aria-label="close" data-close="profile-modal"></button>
      </header>
      <section class="modal-card-body">
        <!-- Profile Form -->
        <form id="profile-form">
          <label>Full Name:</label>
          <input type="text" class="input" name="Full Name" id="profile-fullname" required>
          <label>Salary:</label>
          <input type="number" class="input" name="Salary" id="profile-salary" required>
        </form>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" type="submit" id="saveProfileButton" form="profile-form">Submit</button>
        <button class="button is-warning" type="reset" id="resetForm">Reset</button>
        <button class="button" data-close="profile-modal" id="closeModalFooter">Close</button>
      </footer>
    </div>
  </div>
  <!-- Credit Card Modal -->
  <div class="modal" id="credit-card-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title is-size-5">Add Credit Card</p>
        <button class="delete" aria-label="close" data-close="credit-card-modal"></button>
      </header>
      <section class="modal-card-body">
        <form id="credit-card-form">
          <div id="creditCardMessageBox" class="notify-msg error">success</div>


          <label class="label" for="card-number">Card Number</label>
          <div class="field has-addons">
            <p>
              <input class="input" type="text" value="XXXX-XXXX-XXXX-" disabled>
            </p>
            <p class="control">
              <input class="input" type="number" id="cardLast4" name="cardNumber" id="card-number" maxlength="4"
                width="12rem" pattern="\d{4}" required placeholder="XXXX">
            </p>
          </div>

          <div class="field">
            <label class="label" for="bank-name">Bank Name</label>
            <div class="control">
              <div class="select">
                <select id="bank-name" name="bankName" required>
                  <option value="" disabled selected>Select Bank</option>
                  <option value="SBI">SBI</option>
                  <option value="AXIS">AXIS</option>
                  <option value="HDFC">HDFC</option>
                  <option value="ICICI">ICICI</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label" for="card-limit">Limit</label>
            <div class="control">
              <input class="input" type="number" id="card-limit" name="cardLimit" placeholder="Enter limit" required />
            </div>
          </div>
        </form>
      </section>
      <footer class="modal-card-foot">
        <button type="submit" class="button is-primary" form="credit-card-form"
          id="saveCreditCardButton">Submit</button>
        <button class="button is-warning" type="reset" form="credit-card-form">Reset</button>
        <button class="button" data-close="credit-card-modal">Cancel</button>
      </footer>
    </div>
  </div>
</body>
<script>
  const apiUrl = "https://script.google.com/macros/s/AKfycbzhpA6EIQ44KcBAhMGcRLjgzvSIbhQogo5BZBI01_ODk9K3pV0PdSok65xYAIpXZc4/exec"; // Replace with your Apps Script URL

  const colorPalletes = ["#ecf5fc", "#e8f7e6", "#fceced", "#fff8dc"];
  let currentPage = 1;
  const ITEMS_PER_PAGE = 50; // Number of items per 
  let transactionData = [];
  let isEditing = false; // Flag to check if we are editing
  let editingRowNumber = null; // Row number to edit

  async function fetchData() {
    try {
      const response = await fetch(`${apiUrl}?action=getTransaction`); // Replace with your Web App URL
      transactionData = await response.json();
      //console.log(data);
      TransactionPage(currentPage)
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }
  // Function to render a page of data
  function TransactionPage(page) {
    const container = document.getElementById('transaction-list');
    container.innerHTML = ''; // Clear current content

    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const currentPageData = transactionData.slice(start, end);

    currentPageData.forEach(transaction => {
      let category = getCategoryDetails(transaction.spendCategory)

      container.innerHTML += `
          <div class="media hlp">
            <figure class="media-left">
              <span class="icon ${category.color}">
                ${category.icon}
              </span>
            </figure>
            <div class="media-content">
              <p class="title is-6 one-line">${capitalizeFirstLetter(transaction.item)}</p>
              <p class="subtitle is-7 one-line">
                Date: ${formatDateToDDMMYY(transaction.date)} 
                <span class="has-text-grey">| Card: ${transaction.card}</span>
              </p>
            </div>
            <div class="media-right">
              <p class="has-text-weight-bold">${formatAmountInINR(transaction.amount)}</p>
            </div>
          </div>
          <hr>
        `;
    });

    renderPagination(page); // Render pagination controls
  }

  // Function to render pagination controls
  function renderPagination(activePage) {
    const paginationControls = document.getElementById('pagination-controls');
    paginationControls.innerHTML = ''; // Clear current controls

    const totalPages = Math.ceil(transactionData.length / ITEMS_PER_PAGE);

    for (let i = 1; i <= totalPages; i++) {
      paginationControls.innerHTML += `
          <button class="button ${i === activePage ? 'is-primary' : ''}" onclick="changePage(${i})">
            ${i}
          </button>
        `;
    }
  }

  // Function to handle page change
  function changePage(page) {
    currentPage = page;
    TransactionPage(page);
  }

  function showSection(sectionId, navId) {

    // Hide all sections
    const sections = document.querySelectorAll('.section');
    const links = document.querySelectorAll('.nav-item');
    sections.forEach(section => section.classList.remove('active'));
    links.forEach(link => link.classList.remove('active'));
    // Show the selected section
    const selectedSection = document.getElementById(sectionId);
    const selectedNav = document.getElementById(navId);
    selectedSection.classList.add('active');
    selectedNav.classList.add('active');
  }
  function renderDashboard(data) {
    const container = document.getElementById('dashboard-content');

  }
  async function loadDashboardData(tableId) {
    let editData = {}
    try {
      const response = await fetch(`${apiUrl}?action=getDashboard`);
      const data = await response.json();
      const dashboardContent = document.getElementById("dashboard-content");
      dashboardContent.innerHTML = ""; // Clear existing content

      const tableBody = document.getElementById(tableId);
      tableBody.innerHTML = ""; // Clear table contents before adding new rows
      //console.log(data);
      data.cards.forEach((card, index) => {
        const tr = document.createElement("tr");
        const td = document.createElement("td");

        dashboardContent.innerHTML += `
    <div class="column is-half">
          <div class="card-details">
            <div class="card-title">${card.name}</div>
            <div class="data-item">
              <span class="data-item-title">Utilized:</span>
              <span class="data-item-value">${formatAmountInINR(card.utilized)}</span>
              <span>(${utilizedPercent(card.utilized, card.total)}%)</span>
            </div>
            <div class="data-item">
              <span class="data-item-title">Avai. Limit:</span>
              <span class="data-item-value">${formatAmountInINR(card.remaining)}</span>
            </div>
            <div class="data-item">
              <span class="data-item-title">Credit Limit:</span>
              <span class="data-item-value">${formatAmountInINR(card.total)}</span>
            </div>
          </div>
        </div>
    `
        editData = { cardNumber: card.name.split("-")[1], bankName: card.name.split("-")[0], cardLimit: card.total }
        tableBody.innerHTML += `
    <tr>
    <td class="is-size-7-mobile">${card.name}</td>
    <td class="is-size-7-mobile">${card.total}</td>
    <td class="is-size-7-mobile">${card.utilized}</td>
    <td class="is-size-7-mobile">${card.remaining}</td>
    <td class="is-size-7-mobile">
      <button class="button is-small is-warning is-size-7-mobile" onclick="editData('Credit Card', ${index + 2},${JSON.stringify(editData).replace(/"/g, '&quot;')} )"><i class="fas fa-edit"> </i></button>
      <button class="button is-small is-danger" onclick="deleteData('Credit Card', ${index + 2})"><i class="fas fa-trash"> </i></button>
    </td>
      </tr>
    `
      });
      //console.log(editData);
      const cardDetails = document.querySelectorAll('.card-details');
      cardDetails.forEach((cardDetail, index) => {
        cardDetail.style.backgroundColor = colorPalletes[index];
      })
    } catch (error) {
      console.error("Error loading dashboard data:", error);
    }
  }

  function getCategoryDetails(category) {
    if (typeof category !== "string") {
      return {
        icon: '<i class="fas fa-question"></i>',
        color: "has-text-dark"
      };
    }

    const formattedCategory = category.toLowerCase().trim().replace(/\s+/g, " ");

    const categoryMap = {
      "recurring": { icon: '<i class="fas fa-arrows-rotate"></i>', color: "has-text-danger" },
      "medical": { icon: '<i class="fas fa-notes-medical"></i>', color: "has-text-info" },
      "periodic": { icon: '<i class="fas fa-calendar-alt"></i>', color: "has-text-primary" },
      "non-essential": { icon: '<i class="fas fa-shopping-bag"></i>', color: "has-text-warning" }
    };

    return categoryMap[formattedCategory] || { icon: '<i class="fas fa-question"></i>', color: "has-text-dark" };
  }


  function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }
  function formatAmountInINR(amount) {

    return new Intl.NumberFormat('en-IN', {
      style: 'currency',
      currency: 'INR',
      maximumFractionDigits: 0,
    }).format(amount);
  }


  function handleModal(modalId, action) {
    const modal = document.getElementById(modalId);
    const form = document.getElementById(`${modalId.toLowerCase().replace("modal", "form")}`);

    if (modal) {
      if (action === 'open') {
        modal.classList.add('is-active');
      } else if (action === 'close') {
        modal.classList.remove('is-active');
        isEditing = false;
        form.reset()
      }
    }
    console.log("isEditing" + isEditing);

  }

  // Event listeners for opening modals
  document.querySelectorAll('[data-modal]').forEach(button => {
    button.addEventListener('click', function () {
      const modalId = this.getAttribute('data-modal');
      handleModal(modalId, 'open');
    });
  });

  // Event listeners for closing modals
  document.querySelectorAll('[data-close]').forEach(button => {
    button.addEventListener('click', function () {
      const modalId = this.getAttribute('data-close');
      handleModal(modalId, 'close');
    });
  });

  // Close modal on background click
  document.querySelectorAll('.modal-background').forEach(background => {
    background.addEventListener('click', function () {
      const modal = this.closest('.modal');
      if (modal) {
        handleModal(modal.id, 'close');
      }
    });
  });

  // Helper Function: Display Messages
  function showMessage(messageBox, type, message) {
    messageBox.className = `notify ${type}`;
    messageBox.textContent = message;
    messageBox.style.visibility = "visible";
    setTimeout(() => {
      messageBox.style.visibility = "hidden";
    }, 3000);
  }

  function submitData(module, formId) {
    const form = document.getElementById(formId);
    var formData = new FormData(form);
    const action = isEditing ? "edit" : "add";

    if (formId === 'credit-card-form') {
      var data = Object.fromEntries(formData.entries())
      const card = `${data.bankName}-${data.cardNumber}`
      const utilized = 0;
      var rem = 0;

      if (isEditing) {
        rem = `=IF(A${editingRowNumber}<>"",B${editingRowNumber}-D${editingRowNumber})`
        data = { card, ...data, rem }
      } else {
        data = { card, ...data, rem, utilized }
      }
      delete data.cardNumber;
      delete data.bankName;


      console.log("datasubmit:" + JSON.stringify(data, null));
    } else {
      var data = {}
      // Convert form data into JSON object
      formData.forEach((value, key) => {
        data[key] = value;
      });
      console.log("datasubmit:" + JSON.stringify(data, null));
    }
    // Object.assign(data, { utilized: 100, rem: '=IF(A3<>"",C3-D3,"")' })
    // console.log("daaaa: " + data);
    try {
      if (isEditing) {
        data.rowNumber = editingRowNumber; // Include the row number for editing
      }
      fetch(apiUrl, {
        redirect: "follow",
        method: "POST",
        headers: {
          "Content-Type": "text/plain;charset=utf-8",
        },
        body: JSON.stringify({ action, module, data }),
      });

      form.reset();
      isEditing = false;
      // alert(`${module} data added successfully!`);
      // loadTableData(module, `${module.toLowerCase().replace(" ", "-")}-table`);
      alert(`${module} data ${isEditing ? "updated" : "added"} successfully!`);
      //console.log(`${module.toLowerCase().replace(" ", "-")}-table`);
      console.log("modal id:" + `${module.toLowerCase().replace(" ", "-")}-modal`);
      if (formId === 'credit-card-form') {
        loadDashboardData("credit-card-table")
      } else {
        loadTableData(module, `${module.toLowerCase().replace(" ", "-")}-table`, module);
      }
      handleModal(`${module.toLowerCase().replace(" ", "-")}-modal`, 'close')

    } catch (error) {
      console.error(`Error adding data to ${module}:`, error);
    }
  }

  // Edit Data Function
  window.editData = function (module, rowNumber, rowData) {
    isEditing = true;
    editingRowNumber = rowNumber; // Save row number for editing
    const formId = `${module.toLowerCase().replace(" ", "-")}-form`;
    const form = document.getElementById(formId);
    console.log(module);
    console.log(rowData);
    console.log("Row Data Keys:", Object.keys(rowData));
    // Populate the form fields with the existing data
    Object.keys(rowData).forEach((key) => {
      if (form.elements[key]) {
        form.elements[key].value = rowData[key];
      }
    });

    // Open the corresponding modal
    //modals[module.toLowerCase().replace("s", "")].classList.add("is-active");
    handleModal(`${module.toLowerCase().replace(" ", "-")}-modal`, 'open')
  }

  function deleteData(module, rowNumber) {
    if (!confirm("Are you sure you want to delete this record?")) return;

    try {
      fetch(apiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "text/plain;charset=utf-8",
        },
        body: JSON.stringify({ action: "delete", module, data: { rowNumber } }),
      });
      alert(`${module} data deleted successfully!`);
      if (module === 'Profile') {
        loadTableData(module, `${module.toLowerCase().replace(" ", "-")}-table`);
      } else {
        loadDashboardData(`${module.toLowerCase().replace(" ", "-")}-table`)
      }

    } catch (error) {
      console.error(`Error deleting data from ${module}:`, error);
    }
  }

  // Attach the functions to the global scope:
  // window.editData = editData;
  window.deleteData = deleteData;

  // Form Submission Handlers
  document.getElementById("saveProfileButton").addEventListener("click", (e) => {
    e.preventDefault();
    submitData("Profile", "profile-form");
    // handleModal(modalId, 'close');
  });

  document.getElementById("saveCreditCardButton").addEventListener("click", (e) => {
    e.preventDefault();
    submitData("Credit Card", "credit-card-form");
  });

  // document.getElementById("transaction-form").addEventListener("submit", (e) => {
  //   e.preventDefault();
  //   submitData("Transactions", "transaction-form");
  //   //modals.transaction.classList.remove("is-active");
  // });

  function loadTableData(module, tableId) {
    fetch(`${apiUrl}?action=get&module=${module}`)
      .then(response => response.json())
      .then(data => {
        //const { transactions, creditCards, profiles } = data
        const tableBody = document.getElementById(tableId);
        tableBody.innerHTML = ""; // Clear table contents before adding new rows

        data.forEach((row, index) => {
          const tr = document.createElement("tr");
          Object.values(row).forEach((value) => {
            const td = document.createElement("td");
            td.textContent = value;
            tr.appendChild(td);
          });

          // Add Edit and Delete buttons
          const actionTd = document.createElement("td");
          actionTd.innerHTML = `
                    <button class="button is-small is-warning" onclick="editData('${module}', ${index + 2},${JSON.stringify(row).replace(/"/g, '&quot;')} )"><i class="fas fa-edit"> </i></button>
                    <button class="button is-small is-danger" onclick="deleteData('${module}', ${index + 2})"><i class="fas fa-trash"> </i></button>
                `;
          tr.appendChild(actionTd);

          tableBody.appendChild(tr);
        })
      })

      .catch(error => {
        console.error("Error loading data:", error);
        document.getElementById('error-message').classList.remove('is-hidden');
      });
  }

  // Fetch Card Numbers for Transaction Form
  function fetchCardNumbers() {
    fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "text/plain;charset=utf-8",
      },
      // Send the action in the request body.
      body: JSON.stringify({ action: "getCards" })

    }).then(function (response) {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      return response.json();
    })
      .then(function (data) {
        console.log(data);

        data.data.forEach(function (card) {
          const option = document.createElement('option');
          option.value = card;
          option.textContent = card;
          transactionCardDropdown.appendChild(option);
        });
      })
      .catch(error => console.error("Error fetching card numbers:", error));
  }

  function formattedDate() {
    const currentDate = new Date();
    const day = String(currentDate.getDate()).padStart(2, '0'); // Ensures two digits
    const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Month starts from 0
    const year = String(currentDate.getFullYear()).slice(-2); // Gets last two digits of the year

    const formattedDate = `${day}-${month}-${year}`;
    //console.log(formattedDate); // Outputs something like "14-04-25"
    return formattedDate;
  }

  function formatDateToDDMMYY(isoTimestamp) {
    // Create a Date object from the ISO timestamp
    let date = new Date(isoTimestamp);

    // Convert to IST (UTC+5:30)
    date.setMinutes(date.getMinutes() + 330);

    // Extract day, month, and year
    let day = String(date.getDate()).padStart(2, '0');
    let month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
    let year = String(date.getFullYear()).slice(-2);

    return `${day}-${month}-${year}`;
  }
  function utilizedPercent(utilized, limit) {
    const utilizedPer = utilized / limit * 100;
    return Math.floor(utilizedPer);
  }

  const secondSetData = [
    { item: "Recurring", icon: "fas fa-sync" },
    { item: "Medical", icon: "fas fa-credit-card" },
    { item: "Periodic", icon: "fas fa-wallet" },
    { item: "Non-essential", icon: "fas fa-wallet" }
  ];

  // Define light pastel colors for the buttons
  const colorMap = ["#e6f7ff", "#fef6e4", "#f3e9f7", "#fff8e6", "#f0fff4"];

  const selectedLabel = document.getElementById('selected-label');
  const buttonSet1 = document.getElementById('button-set-1');
  const buttonSet2 = document.getElementById('button-set-2');
  const formContainer = document.getElementById('form-container');
  const backButton = document.getElementById('back-button');
  const submitButton = document.getElementById('submit-button');
  const item = document.getElementById('input-item');
  const amount = document.getElementById('input-amount');

  let selectedItems = { firstSet: null, secondSet: null }; // Separate selections into categories

  // Create dynamic buttons
  function createButtons(data, container, onClick) {
    container.innerHTML = ""; // Clear existing buttons

    data.forEach((item, index) => {
      var cardIcon = getCardIcon(item.item)
      const button = document.createElement('button');
      button.className = 'button custom-button';
      button.style.backgroundColor = colorMap[index % colorMap.length]; // Assign light color

      const iconSpan = document.createElement('i');
      iconSpan.className = cardIcon;

      const textSpan = document.createElement('span');
      textSpan.innerText = item.item;

      button.appendChild(iconSpan);
      button.appendChild(textSpan);

      button.addEventListener('click', () => onClick(item));
      container.appendChild(button);
    });
  }

  // Display second set and update selection for the first set
  function handleFirstSetClick(item) {
    selectedItems.firstSet = item.item; // Assign first set selection
    updateSelectedLabel();
    buttonSet1.classList.add('hidden');
    buttonSet2.classList.remove('hidden');
    backButton.classList.remove('hidden');
  }

  // Update selection for the second set
  function handleSecondSetClick(item) {
    selectedItems.secondSet = item.item; // Assign second set selection
    updateSelectedLabel();
    buttonSet2.classList.add('hidden');
    formContainer.classList.remove('hidden');
  }

  // Update the "Selected" label
  function updateSelectedLabel() {
    const selections = [];
    if (selectedItems.firstSet) selections.push(selectedItems.firstSet);
    if (selectedItems.secondSet) selections.push(selectedItems.secondSet);
    selectedLabel.innerText = selections.length > 0
      ? `Selected: ${selections.join(" -> ")}`
      : "Selected: None";
  }

  // Go back to the previous set
  function handleBackClick() {
    if (!formContainer.classList.contains('hidden')) {
      formContainer.classList.add('hidden');
      buttonSet2.classList.remove('hidden');
      backButton.classList.remove('hidden'); // Ensure Back button reappears
      selectedItems.secondSet = null; // Clear second set selection
    } else {
      buttonSet1.classList.remove('hidden');
      buttonSet2.classList.add('hidden');
      selectedItems.firstSet = null; // Clear first set selection
      backButton.classList.add('hidden');
    }
    updateSelectedLabel();
  }

  function goTofirstPage() {
    if (!formContainer.classList.contains('hidden')) {
      formContainer.classList.add('hidden');
      buttonSet1.classList.remove('hidden');
      backButton.classList.remove('hidden'); // Ensure Back button reappears
      selectedItems.secondSet = null; // Clear second set selection
      selectedItems.firstSet = null;
    }
    updateSelectedLabel();
  }

  function getCardIcon(card) {

    if (typeof card !== "string") {
      return "fas fa-coin"; // Default icon if card isn't valid
    }
    //console.log(card);

    switch (card.trim().replace(/\s+/g, " ").split("-")[0].toLowerCase()) {

      case 'sbi': return 'fas fa-money-check';
      case 'hdfc': return 'fas fa-credit-card';
      case 'axis': return 'fas fa-wallet';
      case 'icici': return 'fas fa-money-bill';
      case 'recurring': return 'fas fa-sync';
      case 'medical': return 'fas fa-notes-medical';
      case 'periodic': return 'fas fa-calendar-alt';
      case 'non': return 'fas fa-shopping-bag';
      default: return 'fas fa-question';
    };
  }

  // Submit the form data along with selections
  submitButton.addEventListener('click', () => {
    saveTransactionData('Credit Card')
    //console.log("Submitting Data: ", formData); // Replace with app script submission logic

  });
  function formattedDate() {
    const currentDate = new Date();
    const day = String(currentDate.getDate()).padStart(2, '0'); // Ensures two digits
    const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Month starts from 0
    const year = String(currentDate.getFullYear()).slice(-2); // Gets last two digits of the year

    const formattedDate = `${month}/${day}/${year}`;
    //console.log(formattedDate); // Outputs something like "14-04-25"
    return formattedDate;
  }


  // Add back button functionality
  backButton.addEventListener('click', handleBackClick);

  // Fetch Card Numbers for Transaction Form
  function saveTransactionData(module) {
    if (item.value === "" || amount.value === "") {
      return false;
    }
    const data = {
      date: formattedDate(),
      card: selectedItems.firstSet,
      item: item.value,
      category: selectedItems.secondSet,
      amount: amount.value
    };
    fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "text/plain;charset=utf-8",
      },
      // Send the action in the request body.
      body: JSON.stringify({ action: "add", module: 'Transaction', data })

    }).then(function (response) {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      alert('Transaction data saved successfully..!')
      loadTableData(module, `${module.toLowerCase().replace(" ", "-")}-table`);
      loadDashboardData(`${module.toLowerCase().replace(" ", "-")}-table`)

      goTofirstPage()
    })
      .catch(error => console.error("Error fetching card numbers:", error))
  }

  async function getButtonsData() {
    var firstSetData = {}
    try {
      const response = await fetch(`${apiUrl}?action=getCards`);
      var data = await response.json();
      // Generate buttons
      createButtons(data, buttonSet1, handleFirstSetClick);

    } catch (error) {
      console.error("Error loading button data:", error);
    }
  }
  createButtons(secondSetData, buttonSet2, handleSecondSetClick);
  getButtonsData()

  loadDashboardData("credit-card-table")
  // Load data for all modules
  loadTableData("Profile", "profile-table");
  // loadTableData("Credit Cards", "credit-cards-table");
  window.onload = fetchData;
</script>

</html>